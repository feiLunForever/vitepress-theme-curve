---
title: åŸºç¡€ç¯‡
tags:
  - JAVA
categories:
  - JAVA
date: '2025-01-03'
description: æ¬¢è¿ä½¿ç”¨ Curve ä¸»é¢˜ï¼Œè¿™æ˜¯ä½ çš„ç¬¬ä¸€ç¯‡æ–‡ç« 
articleGPT: è¿™æ˜¯ä¸€ç¯‡åˆå§‹åŒ–æ–‡ç« ï¼Œæ—¨åœ¨å‘Šè¯‰ç”¨æˆ·ä¸€äº›ä½¿ç”¨è¯´æ˜å’Œé¡»çŸ¥ã€‚
#cover: "/images/logo/logo.webp"
---
# åŸºç¡€ç¯‡

## == ã€equalsã€hashCode

### ==

* **åŸºæœ¬æ•°æ®ç±»å‹**ï¼šæ¯”è¾ƒå€¼æ˜¯å¦ç›¸ç­‰ã€‚
* **å¼•ç”¨æ•°æ®ç±»å‹**ï¼šæ¯”è¾ƒå†…å­˜åœ°å€æ˜¯å¦ç›¸åŒï¼Œå³åˆ¤æ–­æ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡ã€‚

### equals()

* **æœªè¦†ç›–**ï¼šä¸ `==`â€‹ åŠŸèƒ½ç›¸åŒï¼Œæ¯”è¾ƒå†…å­˜åœ°å€ã€‚
* **å·²è¦†ç›–**ï¼šé€šå¸¸ç”¨äºæ¯”è¾ƒå¯¹è±¡å†…å®¹æ˜¯å¦ç›¸ç­‰ã€‚ä¾‹å¦‚ï¼Œ`String`â€‹ ç±»çš„ `equals`â€‹ æ–¹æ³•è¢«é‡å†™ï¼Œæ¯”è¾ƒçš„æ˜¯å­—ç¬¦ä¸²å†…å®¹è€Œéå†…å­˜åœ°å€ã€‚

### hashCode

* **ä½œç”¨**ï¼šè·å–å“ˆå¸Œç ï¼Œç”¨äºç¡®å®šå¯¹è±¡åœ¨å“ˆå¸Œè¡¨ä¸­çš„ç´¢å¼•ä½ç½®ã€‚
* **é»˜è®¤å®ç°**ï¼šåœ¨ `Object`â€‹ ç±»ä¸­å®šä¹‰ï¼Œæ‰€æœ‰ Java ç±»éƒ½åŒ…å«æ­¤æ–¹æ³•ã€‚

#### hashCode çš„å¿…è¦æ€§

* **HashSet æ“ä½œ**ï¼šæ·»åŠ å¯¹è±¡æ—¶ï¼Œå…ˆè®¡ç®— `hashCode`â€‹ ç¡®å®šä½ç½®ï¼Œå†æ¯”è¾ƒ `hashCode`â€‹ åˆ¤æ–­å¯¹è±¡æ˜¯å¦ä¸€è‡´ã€‚
* **æ€§èƒ½ä¼˜åŒ–**ï¼šè‹¥ `hashCode`â€‹ ç›¸åŒï¼Œåˆ™ä½¿ç”¨ `equals`â€‹ æ–¹æ³•è¿›ä¸€æ­¥åˆ¤æ–­ã€‚è¿™æ ·å¯ä»¥å‡å°‘ `equals`â€‹ æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°ï¼Œæé«˜æ‰§è¡Œé€Ÿåº¦ã€‚

#### é‡å†™ equalsï¼Œå¿…é¡»é‡å†™ hashcode

* set å»é‡æ—¶ï¼Œå…ˆåˆ¤æ–­ hashcode æ˜¯å¦ç›¸åŒ
* æ²¡æœ‰é‡å†™ hashcodeï¼Œä¼šè°ƒç”¨ Object çš„ hashcodeï¼Œæ¯”è¾ƒåœ°å€ï¼Œå°±ä¼šå‡ºç°ä¸¤ä¸ªå¯¹è±¡ï¼Œå„ä¸ªå€¼ç›¸ç­‰ï¼ˆæœ¬åº”è¯¥å»é‡ï¼‰ä½†æ˜¯æ²¡æœ‰å»é‡çš„æƒ…å†µå‡ºç°

å¦‚æœæˆ‘ä»¬åœ¨ Set é›†åˆä¸­å­˜å‚¨çš„æ˜¯ï¼Œåªé‡å†™äº† equals æ–¹æ³•çš„è‡ªå®šä¹‰å¯¹è±¡æ—¶ï¼Œæœ‰è¶£çš„äº‹æƒ…å°±å‘ç”Ÿäº†ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```java
import java.util.HashSet;
import java.util.Objects;

class Person {
    private String name;
    private int age;

    public Person(String name, int age) {
        this.name = name;
        this.age = age;
    }

    // é‡å†™ equals æ–¹æ³•ï¼Œä½†æœªé‡å†™ hashCode æ–¹æ³•
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Person person = (Person) o;
        return age == person.age &&
                Objects.equals(name, person.name);
    }

    // æœªé‡å†™ hashCode æ–¹æ³•
    // @Override
    // public int hashCode() {
    //     return Objects.hash(name, age);
    // }
}

public class HashCodeExample {
    public static void main(String[] args) {
        HashSet<Person> set = new HashSet<>();
        Person p1 = new Person("Java", 18);
        Person p2 = new Person("Java", 18);

        set.add(p1);
        set.add(p2);

        System.out.println("HashSet size: " + set.size()); // åº”è¾“å‡º 1ï¼Œä½†å®é™…è¾“å‡º 2
    }
}
```

ä»¥ä¸Šç¨‹åºçš„æ‰§è¡Œç»“æœï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š![1688114432645-7005ad47-44d8-4b89-9144-c2d58f006f69-20231120175109561](https://gitee.com/JBL_lun/tuchuang/raw/master/assets/1688114432645-7005ad47-44d8-4b89-9144-c2d58f006f69-20231120175109561-20231204150052-ozogg21.webp)â€‹

ä»ä¸Šè¿°ä»£ç å’Œä¸Šè¿°å›¾ç‰‡å¯ä»¥çœ‹å‡ºï¼Œå³ä½¿ä¸¤ä¸ªå¯¹è±¡æ˜¯ç›¸ç­‰çš„ï¼ŒSet é›†åˆç«Ÿç„¶æ²¡æœ‰å°†äºŒè€…è¿›è¡Œå»é‡ä¸åˆå¹¶ã€‚è¿™å°±æ˜¯é‡å†™äº† equals æ–¹æ³•ï¼Œä½†æ²¡æœ‰é‡å†™ hashCode æ–¹æ³•çš„é—®é¢˜æ‰€åœ¨ã€‚

#### ä¸ºä»€ä¹ˆä¸¤ä¸ªå¯¹è±¡æœ‰ç›¸åŒçš„ hashcode å€¼ï¼Œå®ƒä»¬ä¹Ÿä¸ä¸€å®šæ˜¯ç›¸ç­‰çš„

ä¸¤ä¸ªå¯¹è±¡å³ä½¿å…·æœ‰ç›¸åŒçš„ `hashCode`â€‹ å€¼ï¼Œä¹Ÿä¸ä¸€å®šç›¸ç­‰ï¼ŒåŸå› åœ¨äº `hashCode()`â€‹ æ–¹æ³•æ‰€ä½¿ç”¨çš„æ•£åˆ—ç®—æ³•å¯èƒ½ä¼šå¯¼è‡´ä¸åŒçš„å¯¹è±¡äº§ç”Ÿç›¸åŒçš„æ•£åˆ—å€¼ã€‚è¿™ç§ç°è±¡ç§°ä¸ºâ€œæ•£åˆ—ç¢°æ’â€ã€‚æ•£åˆ—ç¢°æ’çš„é¢‘ç‡å–å†³äºæ•£åˆ—ç®—æ³•çš„è´¨é‡å’Œæ•°æ®åˆ†å¸ƒçš„ç‰¹æ€§ã€‚è¾ƒå·®çš„æ•£åˆ—ç®—æ³•æ›´æ˜“å‘ç”Ÿç¢°æ’ã€‚

åœ¨ `HashSet`â€‹ ç­‰åŸºäºæ•£åˆ—çš„é›†åˆä¸­ï¼Œå¦‚æœå‘ç°ä¸¤ä¸ªå¯¹è±¡çš„ `hashCode`â€‹ ç›¸åŒï¼Œä¸ºäº†ç¡®å®šå®ƒä»¬æ˜¯å¦çœŸçš„ç›¸åŒï¼Œä¼šè¿›ä¸€æ­¥ä½¿ç”¨ `equals()`â€‹ æ–¹æ³•è¿›è¡Œæ¯”è¾ƒã€‚å› æ­¤ï¼Œ`hashCode()`â€‹ ä¸»è¦ç”¨äºå‡å°‘æŸ¥æ‰¾çš„å¼€é”€ï¼Œè€Œä¸æ˜¯ä½œä¸ºåˆ¤æ–­å¯¹è±¡æ˜¯å¦ç›¸ç­‰çš„ç›´æ¥ä¾æ®ã€‚

#### æ€»ç»“

* å¦‚æœä¸¤ä¸ªå¯¹è±¡ç›¸ç­‰ï¼Œåˆ™ hashcode ä¸€å®šä¹Ÿæ˜¯ç›¸åŒçš„
* ä¸¤ä¸ªå¯¹è±¡ç›¸ç­‰,å¯¹ä¸¤ä¸ªå¯¹è±¡åˆ†åˆ«è°ƒç”¨ equals æ–¹æ³•éƒ½è¿”å› true
* ä¸¤ä¸ªå¯¹è±¡æœ‰ç›¸åŒçš„ hashcode å€¼ï¼Œå®ƒä»¬ä¹Ÿä¸ä¸€å®šæ˜¯ç›¸ç­‰çš„.å› æ­¤ï¼Œequals æ–¹æ³•è¢«è¦†ç›–è¿‡ï¼Œåˆ™ hashCode æ–¹æ³•ä¹Ÿå¿…é¡»è¢«è¦†ç›–
* hashCode() çš„é»˜è®¤è¡Œä¸ºæ˜¯å¯¹å †ä¸Šçš„å¯¹è±¡äº§ç”Ÿç‹¬ç‰¹å€¼ã€‚å¦‚æœæ²¡æœ‰é‡å†™ hashCode()ï¼Œåˆ™è¯¥ class çš„ä¸¤ä¸ªå¯¹è±¡æ— è®ºå¦‚ä½•éƒ½ä¸ä¼šç›¸ç­‰ï¼ˆå³ä½¿è¿™ä¸¤ä¸ªå¯¹è±¡æŒ‡å‘ç›¸åŒçš„æ•°æ®ï¼‰

## serialVersionUID

### ä»€ä¹ˆæ˜¯ serialVersionUID ï¼Ÿ

åœ¨Javaä¸­ï¼Œå¦‚æœä¸€ä¸ªç±»æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œå³å®ç°äº†`java.io.Serializable`â€‹æ¥å£ï¼Œé‚£ä¹ˆå®ƒå¯èƒ½ä¼šåŒ…å«ä¸€ä¸ªåä¸º`serialVersionUID`â€‹çš„é™æ€å¸¸é‡ã€‚è¿™ä¸ªå¸¸é‡æ˜¯ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œç”¨äºåœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­éªŒè¯åºåˆ—åŒ–å¯¹è±¡çš„å‘é€è€…å’Œæ¥æ”¶è€…æ˜¯å¦ä¸ºè¯¥å¯¹è±¡åŠ è½½äº†ä¸åºåˆ—åŒ–å…¼å®¹çš„ç±»ã€‚

1. **ä½œç”¨**ï¼šåºåˆ—åŒ–æ—¶ï¼Œ`serialVersionUID`â€‹ä¼šè¢«å†™å…¥åºåˆ—åŒ–æµä¸­ã€‚å½“å¯¹è±¡è¢«ååºåˆ—åŒ–æ—¶ï¼ŒJavaè™šæ‹Ÿæœºä¼šæ£€æŸ¥ç±»ä¸­çš„`serialVersionUID`â€‹æ˜¯å¦ä¸åºåˆ—åŒ–æµä¸­çš„`serialVersionUID`â€‹ç›¸åŒ¹é…ã€‚å¦‚æœä¸¤è€…ä¸åŒ¹é…ï¼Œåˆ™ååºåˆ—åŒ–å°†ä¼šæŠ›å‡º`InvalidClassException`â€‹å¼‚å¸¸ã€‚

### serialVersionUID ä»€ä¹ˆæ—¶å€™ä¿®æ”¹ï¼Ÿ

> ã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹ä¸­æœ‰ä»¥ä¸‹è§„å®šï¼š
>
> ã€å¼ºåˆ¶ã€‘åºåˆ—åŒ–ç±»æ–°å¢å±æ€§æ—¶ï¼Œè¯·ä¸è¦ä¿®æ”¹ serialVersionUID å­—æ®µï¼Œé¿å…ååºåˆ—å¤±è´¥ï¼›å¦‚æœå®Œå…¨ä¸å…¼å®¹å‡çº§ï¼Œé¿å…ååºåˆ—åŒ–æ··ä¹±ï¼Œé‚£ä¹ˆè¯·ä¿®æ”¹ serialVersionUID å€¼ã€‚

è¯´æ˜ï¼šæ³¨æ„ serialVersionUID ä¸ä¸€è‡´ä¼šæŠ›å‡ºåºåˆ—åŒ–è¿è¡Œæ—¶å¼‚å¸¸ã€‚

### å¼‚å¸¸åœºæ™¯

* å°†æ•°æ®åºåˆ—åŒ–æˆæ–‡ä»¶ï¼Œå†è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œå¦‚æœæ£€æµ‹åˆ°serialVersionUIDä¸ä¸€æ ·ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸
* åœ¨ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚Apache Kafkaã€RabbitMQï¼‰æ—¶ï¼Œæ¶ˆæ¯ç”Ÿäº§è€…ä¼šå°†å¯¹è±¡åºåˆ—åŒ–åå‘é€åˆ°é˜Ÿåˆ—ï¼Œè€Œæ¶ˆè´¹è€…åˆ™ä»é˜Ÿåˆ—ä¸­è¯»å–å¹¶ååºåˆ—åŒ–å¯¹è±¡ã€‚

## å€¼ä¼ é€’å’Œåœ°å€å¼•ç”¨

ç¨‹åºè®¾è®¡è¯­è¨€å°†å®å‚ä¼ é€’ç»™æ–¹æ³•ï¼ˆæˆ–å‡½æ•°ï¼‰çš„æ–¹å¼åˆ†ä¸ºä¸¤ç§ï¼š

* **å€¼ä¼ é€’**ï¼šæ–¹æ³•æ¥æ”¶çš„æ˜¯å®å‚å€¼çš„æ‹·è´ï¼Œä¼šåˆ›å»ºå‰¯æœ¬ã€‚
* **å¼•ç”¨ä¼ é€’**ï¼šæ–¹æ³•æ¥æ”¶çš„ç›´æ¥æ˜¯å®å‚æ‰€å¼•ç”¨çš„å¯¹è±¡åœ¨å †ä¸­çš„åœ°å€ï¼Œä¸ä¼šåˆ›å»ºå‰¯æœ¬ï¼Œå¯¹å½¢å‚çš„ä¿®æ”¹å°†å½±å“åˆ°å®å‚ã€‚

å¾ˆå¤šç¨‹åºè®¾è®¡è¯­è¨€ï¼ˆæ¯”å¦‚ C++ã€ Pascal )æä¾›äº†ä¸¤ç§å‚æ•°ä¼ é€’çš„æ–¹å¼ï¼Œä¸è¿‡ï¼Œ**åœ¨ Java ä¸­åªæœ‰å€¼ä¼ é€’**ã€‚

### ä¸ºä»€ä¹ˆ Java åªæœ‰å€¼ä¼ é€’ï¼Ÿ

**ä¸ºä»€ä¹ˆè¯´ Java åªæœ‰å€¼ä¼ é€’å‘¢ï¼Ÿ**  ä¸éœ€è¦å¤ªå¤šåºŸè¯ï¼Œæˆ‘é€šè¿‡ 3 ä¸ªä¾‹å­æ¥ç»™å¤§å®¶è¯æ˜ã€‚

#### æ¡ˆä¾‹ 1ï¼šä¼ é€’åŸºæœ¬ç±»å‹å‚æ•°

```java
public static void main(String[] args) {
    int num1 = 10;
    int num2 = 20;
    swap(num1, num2);
    System.out.println("num1 = " + num1);
    System.out.println("num2 = " + num2);
}

public static void swap(int a, int b) {
    int temp = a;
    a = b;
    b = temp;
    System.out.println("a = " + a);
    System.out.println("b = " + b);
}
```

è¾“å‡ºï¼š

```plain
a = 20
b = 10
num1 = 10
num2 = 20
```

è§£æï¼š

åœ¨ swap() æ–¹æ³•ä¸­ï¼Œaã€b çš„å€¼è¿›è¡Œäº¤æ¢ï¼Œå¹¶ä¸ä¼šå½±å“åˆ° num1ã€num2ã€‚å› ä¸ºï¼Œaã€b çš„å€¼ï¼Œåªæ˜¯ä» num1ã€num2 çš„å¤åˆ¶è¿‡æ¥çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œaã€b ç›¸å½“äº num1ã€num2 çš„å‰¯æœ¬ï¼Œå‰¯æœ¬çš„å†…å®¹æ— è®ºæ€ä¹ˆä¿®æ”¹ï¼Œéƒ½ä¸ä¼šå½±å“åˆ°åŸä»¶æœ¬èº«ã€‚

![1688285621899-cb4d6d06-4d1e-4f99-a05e-cacfd862959c](https://gitee.com/JBL_lun/tuchuang/raw/master/assets/1688285621899-cb4d6d06-4d1e-4f99-a05e-cacfd862959c-20231204150333-df9523u.png)â€‹

é€šè¿‡ä¸Šé¢ä¾‹å­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†ä¸€ä¸ªæ–¹æ³•ä¸èƒ½ä¿®æ”¹ä¸€ä¸ªåŸºæœ¬æ•°æ®ç±»å‹çš„å‚æ•°ï¼Œè€Œå¯¹è±¡å¼•ç”¨ä½œä¸ºå‚æ•°å°±ä¸ä¸€æ ·ï¼Œè¯·çœ‹æ¡ˆä¾‹ 2ã€‚

#### æ¡ˆä¾‹ 2ï¼šä¼ é€’å¼•ç”¨ç±»å‹å‚æ•° 1

```java
public static void main(String[] args) {
      int[] arr = { 1, 2, 3, 4, 5 };
      System.out.println(arr[0]);
      change(arr);
      System.out.println(arr[0]);
	}

	public static void change(int[] array) {
      // å°†æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ å˜ä¸º0
      array[0] = 0;
	}
```

è¾“å‡ºï¼š

```plain
1
0
```

è§£æï¼š

![img](https://gitee.com/JBL_lun/tuchuang/raw/master/assets/1688285664367-a3907c13-2048-4b68-a61b-af646d5a8933-20231204140254-clt2p2b.png)â€‹

çœ‹äº†è¿™ä¸ªæ¡ˆä¾‹å¾ˆå¤šäººè‚¯å®šè§‰å¾— Java å¯¹å¼•ç”¨ç±»å‹çš„å‚æ•°é‡‡ç”¨çš„æ˜¯å¼•ç”¨ä¼ é€’ã€‚

å®é™…ä¸Šï¼Œå¹¶ä¸æ˜¯çš„ï¼Œè¿™é‡Œä¼ é€’çš„è¿˜æ˜¯å€¼ï¼Œä¸è¿‡ï¼Œè¿™ä¸ªå€¼æ˜¯å®å‚çš„åœ°å€ç½¢äº†ï¼

ä¹Ÿå°±æ˜¯è¯´ change æ–¹æ³•çš„å‚æ•°æ‹·è´çš„æ˜¯ arr ï¼ˆå®å‚ï¼‰çš„åœ°å€ï¼Œå› æ­¤ï¼Œå®ƒå’Œ arr æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªæ•°ç»„å¯¹è±¡ã€‚è¿™ä¹Ÿå°±è¯´æ˜äº†ä¸ºä»€ä¹ˆæ–¹æ³•å†…éƒ¨å¯¹å½¢å‚çš„ä¿®æ”¹ä¼šå½±å“åˆ°å®å‚ã€‚

ä¸ºäº†æ›´å¼ºæœ‰åŠ›åœ°åé©³ Java å¯¹å¼•ç”¨ç±»å‹çš„å‚æ•°é‡‡ç”¨çš„ä¸æ˜¯å¼•ç”¨ä¼ é€’ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹é¢è¿™ä¸ªæ¡ˆä¾‹ï¼

#### æ¡ˆä¾‹ 3ï¼šä¼ é€’å¼•ç”¨ç±»å‹å‚æ•° 2

```java
public class Person {
    private String name;
   // çœç•¥æ„é€ å‡½æ•°ã€Getter&Setteræ–¹æ³•
}

public static void main(String[] args) {
    Person xiaoZhang = new Person("å°å¼ ");
    Person xiaoLi = new Person("å°æ");
    swap(xiaoZhang, xiaoLi);
    System.out.println("xiaoZhang:" + xiaoZhang.getName());
    System.out.println("xiaoLi:" + xiaoLi.getName());
}

public static void swap(Person person1, Person person2) {
    Person temp = person1;
    person1 = person2;
    person2 = temp;
    System.out.println("person1:" + person1.getName());
    System.out.println("person2:" + person2.getName());
}
```

è¾“å‡º:

```plain
person1:å°æ
person2:å°å¼ 
xiaoZhang:å°å¼ 
xiaoLi:å°æ
```

è§£æï¼š

æ€ä¹ˆå›äº‹ï¼Ÿï¼Ÿï¼Ÿä¸¤ä¸ªå¼•ç”¨ç±»å‹çš„å½¢å‚äº’æ¢å¹¶æ²¡æœ‰å½±å“å®å‚å•Šï¼

swap æ–¹æ³•çš„å‚æ•° person1 å’Œ person2 åªæ˜¯æ‹·è´çš„å®å‚ xiaoZhang å’Œ xiaoLi çš„åœ°å€ã€‚å› æ­¤ï¼Œ person1 å’Œ person2 çš„äº’æ¢åªæ˜¯æ‹·è´çš„ä¸¤ä¸ªåœ°å€çš„äº’æ¢ç½¢äº†ï¼Œå¹¶ä¸ä¼šå½±å“åˆ°å®å‚ xiaoZhang å’Œ xiaoLi ã€‚

![img](https://gitee.com/JBL_lun/tuchuang/raw/master/assets/1688285664402-0f96a374-0836-4b86-88e1-4cd4b77e13cd-20231204140254-xftbun0.png)â€‹

### å¼•ç”¨ä¼ é€’æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ

çœ‹åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä½ å·²ç»çŸ¥é“äº† Java ä¸­åªæœ‰å€¼ä¼ é€’ï¼Œæ˜¯æ²¡æœ‰å¼•ç”¨ä¼ é€’çš„ã€‚ ä½†æ˜¯ï¼Œå¼•ç”¨ä¼ é€’åˆ°åº•é•¿ä»€ä¹ˆæ ·å‘¢ï¼Ÿä¸‹é¢ä»¥ C++ çš„ä»£ç ä¸ºä¾‹ï¼Œè®©ä½ çœ‹ä¸€ä¸‹å¼•ç”¨ä¼ é€’çš„åºå±±çœŸé¢ç›®ã€‚

```cpp
#include <iostream>

void incr(int& num)
{
    std::cout << "incr before: " << num << "\n";
    num++;
    std::cout << "incr after: " << num << "\n";
}

int main()
{
    int age = 10;
    std::cout << "invoke before: " << age << "\n";
    incr(age);
    std::cout << "invoke after: " << age << "\n";
}
```

è¾“å‡ºç»“æœï¼š

```plain
invoke before: 10
incr before: 10
incr after: 11
invoke after: 11
```

åˆ†æï¼šå¯ä»¥çœ‹åˆ°ï¼Œåœ¨ incr å‡½æ•°ä¸­å¯¹å½¢å‚çš„ä¿®æ”¹ï¼Œå¯ä»¥å½±å“åˆ°å®å‚çš„å€¼ã€‚è¦æ³¨æ„ï¼šè¿™é‡Œçš„ incr å½¢å‚çš„æ•°æ®ç±»å‹ç”¨çš„æ˜¯ int& æ‰ä¸ºå¼•ç”¨ä¼ é€’ï¼Œå¦‚æœæ˜¯ç”¨ int çš„è¯è¿˜æ˜¯å€¼ä¼ é€’å“¦ï¼

### ä¸ºä»€ä¹ˆ Java ä¸å¼•å…¥å¼•ç”¨ä¼ é€’å‘¢ï¼Ÿ

å¼•ç”¨ä¼ é€’çœ‹ä¼¼å¾ˆå¥½ï¼Œèƒ½åœ¨æ–¹æ³•å†…å°±ç›´æ¥æŠŠå®å‚çš„å€¼ä¿®æ”¹äº†ï¼Œä½†æ˜¯ï¼Œä¸ºä»€ä¹ˆ Java ä¸å¼•å…¥å¼•ç”¨ä¼ é€’å‘¢ï¼Ÿ

**æ³¨æ„ï¼šä»¥ä¸‹ä¸ºä¸ªäººè§‚ç‚¹çœ‹æ³•ï¼Œå¹¶éæ¥è‡ªäº Java å®˜æ–¹ï¼š**

> 1. å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œæ–¹æ³•å†…éƒ¨å¯¹å€¼è¿›è¡Œçš„æ“ä½œï¼Œå¯¹äºè°ƒç”¨è€…éƒ½æ˜¯æœªçŸ¥çš„ï¼ˆæŠŠæ–¹æ³•å®šä¹‰ä¸ºæ¥å£ï¼Œè°ƒç”¨æ–¹ä¸å…³å¿ƒå…·ä½“å®ç°ï¼‰ã€‚ä½ ä¹Ÿæƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæ‹¿ç€é“¶è¡Œå¡å»å–é’±ï¼Œå–çš„æ˜¯ 100ï¼Œæ‰£çš„æ˜¯ 200ï¼Œæ˜¯ä¸æ˜¯å¾ˆå¯æ€•ã€‚
> 2. Java ä¹‹çˆ¶ James Gosling åœ¨è®¾è®¡ä¹‹åˆå°±çœ‹åˆ°äº† Cã€C++ çš„è®¸å¤šå¼Šç«¯ï¼Œæ‰€ä»¥æ‰æƒ³ç€å»è®¾è®¡ä¸€é—¨æ–°çš„è¯­è¨€ Javaã€‚åœ¨ä»–è®¾è®¡ Java çš„æ—¶å€™å°±éµå¾ªäº†ç®€å•æ˜“ç”¨çš„åŸåˆ™ï¼Œæ‘’å¼ƒäº†è®¸å¤šå¼€å‘è€…ä¸€ä¸ç•™æ„å°±ä¼šé€ æˆé—®é¢˜çš„â€œç‰¹æ€§â€ï¼Œè¯­è¨€æœ¬èº«çš„ä¸œè¥¿å°‘äº†ï¼Œå¼€å‘è€…è¦å­¦ä¹ çš„ä¸œè¥¿ä¹Ÿå°‘äº†ã€‚

### æ€»ç»“

Java ä¸­å°†å®å‚ä¼ é€’ç»™æ–¹æ³•ï¼ˆæˆ–å‡½æ•°ï¼‰çš„æ–¹å¼æ˜¯ **å€¼ä¼ é€’**ï¼š

* å¦‚æœå‚æ•°æ˜¯åŸºæœ¬ç±»å‹çš„è¯ï¼Œå¾ˆç®€å•ï¼Œä¼ é€’çš„å°±æ˜¯åŸºæœ¬ç±»å‹çš„å­—é¢é‡å€¼çš„æ‹·è´ï¼Œä¼šåˆ›å»ºå‰¯æœ¬ã€‚
* å¦‚æœå‚æ•°æ˜¯å¼•ç”¨ç±»å‹ï¼Œä¼ é€’çš„å°±æ˜¯å®å‚æ‰€å¼•ç”¨çš„å¯¹è±¡åœ¨å †ä¸­åœ°å€å€¼çš„æ‹·è´ï¼ŒåŒæ ·ä¹Ÿä¼šåˆ›å»ºå‰¯æœ¬ã€‚

## Stringã€StringBufferã€StringBuilder

* **String**ï¼š

  * Java 9 ä¹‹å‰ï¼šä½¿ç”¨ `char[] value`â€‹ å­˜å‚¨ã€‚
  * Java 9 ä¹‹åï¼šä½¿ç”¨ `byte[] value`â€‹ å­˜å‚¨ã€‚
* **StringBuilder**ï¼š

  * ç»§æ‰¿è‡ª `AbstractStringBuilder`â€‹ã€‚
  * ä½¿ç”¨ `char[] value`â€‹ å­˜å‚¨ï¼Œä½†æœªç”¨ `final`â€‹ å…³é”®å­—ã€‚
  * çº¿ç¨‹ä¸å®‰å…¨ã€‚
* **StringBuffer**ï¼š

  * ç»§æ‰¿è‡ª `AbstractStringBuilder`â€‹ã€‚
  * ä½¿ç”¨ `char[] value`â€‹ å­˜å‚¨ï¼Œä½†æœªç”¨ `final`â€‹ å…³é”®å­—ã€‚
  * åŠ åŒæ­¥é”ï¼Œçº¿ç¨‹å®‰å…¨ã€‚

## æ•°æ®ç±»å‹ä¸å¸¸é‡æ± 

### è£…ç®±

* `Integer i = 10`â€‹ ç­‰ä»·äº `Integer i = Integer.valueOf(10)`â€‹

### æ‹†ç®±

* `int n = i`â€‹ ç­‰ä»·äº `int n = i.intValue()`â€‹

### åŸºæœ¬ç±»å‹å’ŒåŒ…è£…ç±»å‹åŒºåˆ«

* åŒ…è£…ç±»å‹é»˜è®¤å€¼ä¸º `Null`â€‹ï¼ŒåŸºæœ¬ç±»å‹æœ‰é»˜è®¤å€¼ã€‚
* åŸºæœ¬ç±»å‹å­˜å‚¨åœ¨ JVM æ ˆä¸­ï¼ŒåŒ…è£…ç±»å‹å­˜å‚¨åœ¨å †ä¸­ã€‚
* å®ä¾‹åŒ–æ–¹å¼ä¸åŒï¼Œ`Integer`â€‹ éœ€è¦å®ä¾‹åŒ–ï¼Œ`int`â€‹ ä¸éœ€è¦ã€‚
* æ¯”è¾ƒæ–¹å¼ä¸åŒï¼Œ`int`â€‹ ä½¿ç”¨ `==`â€‹ï¼Œ`Integer`â€‹ ä½¿ç”¨ `equals`â€‹ã€‚

### åŒ…è£…ç±»å‹çš„å¸¸é‡æ± æŠ€æœ¯

* `Byte`â€‹ã€`Short`â€‹ã€`Integer`â€‹ã€`Long`â€‹ é»˜è®¤åˆ›å»º `-128`â€‹ è‡³ `127`â€‹ çš„ç¼“å­˜ã€‚
* `Character`â€‹ åˆ›å»º `0`â€‹ è‡³ `127`â€‹ çš„ç¼“å­˜ã€‚
* `Boolean`â€‹ è¿”å› `True`â€‹ æˆ– `False`â€‹ã€‚
* `Float`â€‹ å’Œ `Double`â€‹ æœªå®ç°å¸¸é‡æ± æŠ€æœ¯ã€‚

ğŸ‘¨â€ğŸ’» **é¢è¯•å®˜** ï¼š åŒ…è£…ç±»å‹çš„å¸¸é‡æ± æŠ€æœ¯äº†è§£ä¹ˆï¼Ÿ

ğŸ™‹ **æˆ‘** ï¼š Java åŸºæœ¬ç±»å‹çš„åŒ…è£…ç±»çš„å¤§éƒ¨åˆ†éƒ½å®ç°äº†å¸¸é‡æ± æŠ€æœ¯ã€‚

**Integer ç¼“å­˜æºä»£ç ï¼š**

```java
/**
 *æ­¤æ–¹æ³•å°†å§‹ç»ˆç¼“å­˜-128 åˆ° 127ï¼ˆåŒ…æ‹¬ç«¯ç‚¹ï¼‰èŒƒå›´å†…çš„å€¼ï¼Œå¹¶å¯ä»¥ç¼“å­˜æ­¤èŒƒå›´ä¹‹å¤–çš„å…¶ä»–å€¼ã€‚
 */
public static Integer valueOf(int i) {
    if(i >= IntegerCache.low && i <= IntegerCache.high) return IntegerCache.cache[i + (-IntegerCache.low)];
    return new Integer(i);
}
```

### è‡ªåŠ¨æ‹†ç®±å¼•å‘çš„ NPE é—®é¢˜

* å½“åŒ…è£…ç±»å‹ä¸º `null`â€‹ æ—¶ï¼Œè‡ªåŠ¨æ‹†ç®±ä¼šå¯¼è‡´ `NullPointerException`â€‹ã€‚
* é¿å…åœ¨æ•°æ®åº“æŸ¥è¯¢ä¸­ä½¿ç”¨åŸºæœ¬ç±»å‹æ¥æ”¶å¯èƒ½ä¸º `null`â€‹ çš„å€¼ã€‚
* ä¸‰ç›®è¿ç®—ç¬¦ä¸­ä½¿ç”¨åŒ…è£…ç±»å‹å’ŒåŸºæœ¬ç±»å‹æ··åˆæ—¶éœ€æ³¨æ„ç±»å‹ä¸€è‡´ï¼Œé¿å…æ‹†ç®±å¯¼è‡´çš„ NPEã€‚

#### æ¡ˆä¾‹ 1

åœ¨ã€Šé˜¿é‡Œå·´å·´å¼€å‘æ‰‹å†Œã€‹ä¸Šå°±æœ‰è¿™æ ·ä¸€æ¡è§„å®šã€‚

![1688455261894-c2c4b755-dca7-428f-a2c7-f89b62bd6881-20231120182519222](https://gitee.com/JBL_lun/tuchuang/raw/master/assets/1688455261894-c2c4b755-dca7-428f-a2c7-f89b62bd6881-20231120182519222-20231204150842-jp2iuw9.png)  
æˆ‘ä»¬ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸€æ¡æ˜¯è¿™æ ·è¯´çš„ï¼šâ€œ**æ•°æ®åº“çš„æŸ¥è¯¢ç»“æœå¯èƒ½æ˜¯ nullï¼Œå› ä¸ºè‡ªåŠ¨æ‹†ç®±ï¼Œç”¨åŸºæœ¬æ•°æ®ç±»å‹æ¥æ”¶æœ‰ NPE é£é™©**â€ã€‚

æˆ‘ä»¬æ¥æ¨¡æ‹Ÿä¸€ä¸ªå®é™…çš„æ¡ˆä¾‹ï¼š

```java
public class AutoBoxTest {
    @Test
    void  should_Throw_NullPointerException(){
        long id = getNum();
    }
    public Long getNum(){
        return null;
    }
}
```

è¿è¡Œä»£ç ä¹‹åï¼Œæœç„¶å‡ºç°äº† **NPE** çš„é—®é¢˜ã€‚

**ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢?**  æˆ‘ä»¬å¯¹ AutoBoxTest.class è¿›è¡Œåç¼–è¯‘æŸ¥çœ‹å…¶å­—èŠ‚ç ï¼ˆæˆ‘æ›´æ¨èä½¿ç”¨ IDEA æ’ä»¶ jclasslib æ¥æŸ¥çœ‹ç±»çš„å­—èŠ‚ç ï¼‰ã€‚

```java
javap -c AutoBoxTest.class
```

åç¼–è¯‘åå¾—åˆ°çš„ should_Throw_NullPointerException() æ–¹æ³•çš„å­—èŠ‚ç å¦‚ä¸‹ï¼š

```java
0 aload_0
1 invokevirtual #2 <AutoBoxTest.getNum>
4 invokevirtual #3 <java/lang/Long.longValue>
7 lstore_1
8 return
```

æˆ‘ä»¬å¯ä»¥å‘ç°è‡ªåŠ¨æ‹†ç®± Long -> long çš„è¿‡ç¨‹ï¼Œä¸è¿‡æ˜¯è°ƒç”¨äº† longValue() æ–¹æ³•ç½¢äº†ï¼

```java
public long longValue() {
   return value;
}
```

ä¹Ÿå°±æ˜¯è¯´ä¸‹é¢ä¸¤è¡Œçš„ä»£ç å®é™…æ˜¯ç­‰ä»·çš„:

```java
long id = getNum();
long id = getNum().longValue();
```

å› ä¸ºï¼ŒgetNum()è¿”å›çš„å€¼ä¸º null ï¼Œä¸€ä¸ª null å€¼è°ƒç”¨æ–¹æ³•ï¼Œå½“ç„¶ä¼šæœ‰ **NPE** çš„é—®é¢˜äº†ã€‚

#### æ¡ˆä¾‹ 2

é€šè¿‡ä¸Šé¢çš„åˆ†æä¹‹åï¼Œæˆ‘æ¥è€ƒäº†ä¸€ä¸ªä¸è®ºæ˜¯å¹³æ—¶å¼€å‘è¿˜æ˜¯é¢è¯•ä¸­éƒ½ç»å¸¸ä¼šç¢°åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼šâ€œ**ä¸‰ç›®è¿ç®—ç¬¦ä½¿ç”¨ä¸å½“ä¼šå¯¼è‡´è¯¡å¼‚çš„ NPE å¼‚å¸¸**â€ã€‚

è¯·ä½ å›ç­”ä¸‹é¢çš„ä»£ç ä¼šæœ‰ **NPE** é—®é¢˜å‡ºç°å—ï¼Ÿå¦‚æœæœ‰ NPE é—®é¢˜å‡ºç°çš„è¯ï¼ŒåŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä½ ä¼šæ€ä¹ˆåˆ†æå‘¢ï¼Ÿ

```java
public class Main {
    public static void main(String[] args) {
        Integer i = null;
        Boolean flag = false;
        System.out.println(flag ? 0 : i);
    }
}
```

ç­”æ¡ˆæ˜¯ä¼šæœ‰ NPE é—®é¢˜å‡ºç°çš„ã€‚  
æˆ‘ä»¬è¿˜æ˜¯é€šè¿‡æŸ¥çœ‹å…¶å­—èŠ‚ç æ¥ææ‡‚èƒŒåçš„åŸç†ï¼ˆè¿™é‡Œå€ŸåŠ©äº† IDEA æ’ä»¶ jclasslib æ¥æŸ¥çœ‹ç±»å­—èŠ‚ç ï¼‰ã€‚

![1688456354709-5243529e-f505-47d8-8e7a-e332ca23b8c5-20231120182519044](https://gitee.com/JBL_lun/tuchuang/raw/master/assets/1688456354709-5243529e-f505-47d8-8e7a-e332ca23b8c5-20231120182519044-20231204151030-ko2xj3l.png)  
ä»å­—èŠ‚ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œ22 è¡Œçš„ä½ç½®å‘ç”Ÿäº† **æ‹†ç®±æ“ä½œ** ã€‚

è¯¦ç»†è§£é‡Šä¸‹å°±æ˜¯ï¼šflag ? 0 : i è¿™è¡Œä»£ç ä¸­ï¼Œ0 æ˜¯åŸºæœ¬æ•°æ®ç±»å‹ intï¼Œè¿”å›æ•°æ®çš„æ—¶å€™ i ä¼šè¢«å¼ºåˆ¶æ‹†ç®±æˆ int ç±»å‹ï¼Œç”±äº i çš„å€¼æ˜¯ nullï¼Œå› æ­¤å°±æŠ›å‡ºäº† NPE å¼‚å¸¸ã€‚

```java
Integer i = null;
Boolean flag = false;
System.out.println(flag ? 0 : i);
```

å¦‚æœï¼Œæˆ‘ä»¬æŠŠä»£ç ä¸­ flag å˜é‡çš„å€¼ä¿®æ”¹ä¸º true çš„è¯ï¼Œå°±ä¸ä¼šå­˜åœ¨ NPE é—®é¢˜äº†ï¼Œå› ä¸ºä¼šç›´æ¥è¿”å› 0ï¼Œä¸ä¼šè¿›è¡Œæ‹†ç®±æ“ä½œã€‚

æˆ‘ä»¬åœ¨å®é™…é¡¹ç›®ä¸­åº”è¯¥é¿å…è¿™æ ·çš„å†™æ³•ï¼Œæ­£ç¡® âœ… ä¿®æ”¹ä¹‹åçš„ä»£ç å¦‚ä¸‹ï¼š

```java
Integer i = null;
Boolean flag = false;
System.out.println(flag ? new Integer(0) : i);// ä¸¤è€…ç±»å‹ä¸€è‡´å°±ä¸ä¼šæœ‰æ‹†ç®±å¯¼è‡´çš„ NPE é—®é¢˜äº†
```

è¿™ä¸ªé—®é¢˜ä¹Ÿåœ¨ ã€Šé˜¿é‡Œå·´å·´å¼€å‘æ‰‹å†Œã€‹ä¸­ è¢«æåˆ°è¿‡ã€‚

![1688456430241-e7ae3729-c8d2-4fbd-8daf-b6cca3fe461c-20231120182603304](https://gitee.com/JBL_lun/tuchuang/raw/master/assets/1688456430241-e7ae3729-c8d2-4fbd-8daf-b6cca3fe461c-20231120182603304-20231204151107-et8b01j.png)â€‹

## å…³é”®å­—

### transient

* **ç”¨é€”**ï¼šç”¨äºé˜»æ­¢å˜é‡åºåˆ—åŒ–ã€‚
* **ä½œç”¨**ï¼šè¢« `transient`â€‹ ä¿®é¥°çš„å˜é‡åœ¨å¯¹è±¡åºåˆ—åŒ–æ—¶ä¸ä¼šè¢«æŒä¹…åŒ–ï¼Œååºåˆ—åŒ–æ—¶ä¹Ÿä¸ä¼šè¢«æ¢å¤ã€‚

### final

* **ç”¨é€”**ï¼š`final`â€‹ ç”¨äºé˜»æ­¢ç»§æ‰¿ã€é‡å†™æˆ–ä¿®æ”¹ã€‚
* **ç”¨æ³•**ï¼š

  1. **ä¿®é¥°ç±»**ï¼šé˜²æ­¢ç±»è¢«ç»§æ‰¿ã€‚
  2. **ä¿®é¥°æ–¹æ³•**ï¼šé˜²æ­¢æ–¹æ³•è¢«é‡å†™ã€‚
  3. **ä¿®é¥°å˜é‡**ï¼šå˜é‡åªèƒ½è¢«èµ‹å€¼ä¸€æ¬¡ã€‚
  4. **ä¿®é¥°å‚æ•°**ï¼šå‚æ•°åœ¨æ–¹æ³•å†…ä¸å…è®¸è¢«ä¿®æ”¹ã€‚

### static

> * `static`â€‹ å…³é”®å­—ç”¨äºå®šä¹‰ç±»çš„é™æ€æˆå‘˜ï¼Œé€‚ç”¨äºé‚£äº›ä¸ç±»å®ä¾‹æ— å…³ã€éœ€è¦å…±äº«çš„èµ„æºã€‚

* **ç”¨é€”**ï¼š`static`â€‹ ç”¨äºå®šä¹‰ç±»çº§åˆ«çš„æˆå‘˜å’Œæ–¹æ³•ã€‚
* **ä½¿ç”¨åœºæ™¯**ï¼š

  1. **ä¿®é¥°æˆå‘˜å˜é‡å’Œæ–¹æ³•**ï¼šå±äºç±»ï¼Œè¢«æ‰€æœ‰å®ä¾‹å…±äº«ï¼Œé€šè¿‡ç±»åè°ƒç”¨ã€‚

      1. è¢« static å£°æ˜çš„æˆå‘˜å˜é‡å±äºé™æ€æˆå‘˜å˜é‡ï¼Œé™æ€å˜é‡å­˜æ”¾åœ¨ Java å†…å­˜åŒºåŸŸçš„æ–¹æ³•åŒºã€‚
      2. è°ƒç”¨æ ¼å¼ï¼š

          * ç±»å.é™æ€å˜é‡å
          * ç±»å.é™æ€æ–¹æ³•å()
  2. **é™æ€ä»£ç å—**ï¼šåœ¨ç±»åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œç”¨äºé™æ€èµ„æºåˆå§‹åŒ–ã€‚

      1. è¯¥ç±»ä¸ç®¡åˆ›å»ºå¤šå°‘å¯¹è±¡ï¼Œé™æ€ä»£ç å—åªæ‰§è¡Œä¸€æ¬¡.
      2. `é™æ€ä»£ç å—â€”>éé™æ€ä»£ç å—â€”>æ„é€ æ–¹æ³•`â€‹
  3. **é™æ€å†…éƒ¨ç±»**ï¼šä¸ä¾èµ–å¤–å›´ç±»å®ä¾‹ï¼Œä¸èƒ½è®¿é—®å¤–å›´ç±»çš„éé™æ€æˆå‘˜ã€‚

      1. é™æ€å†…éƒ¨ç±»ä¸éé™æ€å†…éƒ¨ç±»ä¹‹é—´å­˜åœ¨ä¸€ä¸ªæœ€å¤§çš„åŒºåˆ«: éé™æ€å†…éƒ¨ç±»åœ¨ç¼–è¯‘å®Œæˆä¹‹åä¼šéšå«åœ°ä¿å­˜ç€ä¸€ä¸ªå¼•ç”¨ï¼Œè¯¥å¼•ç”¨æ˜¯æŒ‡å‘åˆ›å»ºå®ƒçš„å¤–å›´ç±»ï¼Œä½†æ˜¯é™æ€å†…éƒ¨ç±»å´æ²¡æœ‰ã€‚
      2. æ²¡æœ‰è¿™ä¸ªå¼•ç”¨å°±æ„å‘³ç€ï¼š

          * å®ƒçš„åˆ›å»ºæ˜¯ä¸éœ€è¦ä¾èµ–å¤–å›´ç±»çš„åˆ›å»ºã€‚
          * å®ƒä¸èƒ½ä½¿ç”¨ä»»ä½•å¤–å›´ç±»çš„é static æˆå‘˜å˜é‡å’Œæ–¹æ³•ã€‚
  4. **é™æ€å¯¼åŒ…**ï¼šå¯¼å…¥ç±»çš„é™æ€èµ„æºï¼Œç›´æ¥ä½¿ç”¨æˆå‘˜å˜é‡å’Œæ–¹æ³•ã€‚

### super

* **ç”¨é€”**ï¼šä»å­ç±»è®¿é—®çˆ¶ç±»çš„å˜é‡å’Œæ–¹æ³•ã€‚
* **ç¤ºä¾‹**ï¼š`super.number`â€‹ å’Œ `super.showNumber()`â€‹ã€‚
* **æ³¨æ„**ï¼šåœ¨æ„é€ å™¨ä¸­ä½¿ç”¨ `super()`â€‹ å’Œ `this()`â€‹ æ—¶éœ€æ”¾åœ¨é¦–è¡Œã€‚
* **é™åˆ¶ï¼š**â€‹`this`â€‹ å’Œ `super`â€‹ ä¸èƒ½ç”¨åœ¨ `static`â€‹ æ–¹æ³•ä¸­ï¼Œå› ä¸ºå®ƒä»¬å±äºå¯¹è±¡èŒƒç•´ï¼Œè€Œé™æ€æ–¹æ³•å±äºç±»èŒƒç•´ã€‚

#### çˆ¶ç±»æ— å‚æ„é€ æ–¹æ³•çš„é‡è¦æ€§

* å¦‚æœçˆ¶ç±»æ²¡æœ‰æ— å‚æ„é€ æ–¹æ³•ï¼Œå­ç±»æ„é€ æ–¹æ³•å¿…é¡»æ˜¾å¼è°ƒç”¨ `super()`â€‹ã€‚
* çˆ¶ç±»ä¸­æ·»åŠ æ— å‚æ„é€ æ–¹æ³•å¯ä»¥é¿å…å­ç±»æ„é€ æ—¶çš„ç¼–è¯‘é”™è¯¯ã€‚

## **åŠ¨æ€ä»£ç†**

### é™æ€ä»£ç†

åœ¨ç¼–è¯‘æ—¶å°±å·²ç»å®ç°ï¼Œç¼–è¯‘å®Œæˆåä»£ç†ç±»æ˜¯ä¸€ä¸ªå®é™…çš„`class`â€‹æ–‡ä»¶ã€‚

* åˆ›å»ºä¸€ä¸ªæ¥å£ï¼Œç„¶ååˆ›å»ºè¢«ä»£ç†çš„ç±»å®ç°è¯¥æ¥å£å¹¶ä¸”å®ç°è¯¥æ¥å£ä¸­çš„æŠ½è±¡æ–¹æ³•ã€‚
* ä¹‹åå†åˆ›å»ºä¸€ä¸ªä»£ç†ç±»ï¼ŒåŒæ—¶ä½¿å…¶ä¹Ÿå®ç°è¿™ä¸ªæ¥å£ã€‚åœ¨ä»£ç†ç±»ä¸­æŒæœ‰ä¸€ä¸ªè¢«ä»£ç†å¯¹è±¡çš„å¼•ç”¨ï¼Œè€Œååœ¨ä»£ç†ç±»æ–¹æ³•ä¸­è°ƒç”¨è¯¥å¯¹è±¡çš„æ–¹æ³•ã€‚

```java
public interface UserDao {  
  	void save();   
}

public class UserDaoImpl implements UserDao {
    @Override
    public void save() {
        System.out.println("æ­£åœ¨ä¿å­˜ç”¨æˆ·...");
    }
}

public class TransactionHandler implements UserDao {
    //ç›®æ ‡ä»£ç†å¯¹è±¡
    private UserDao target;
    //æ„é€ ä»£ç†å¯¹è±¡æ—¶ä¼ å…¥ç›®æ ‡å¯¹è±¡
    public TransactionHandler(UserDao target) {
        this.target = target;
    }
    @Override
    public void save() {
        //è°ƒç”¨ç›®æ ‡æ–¹æ³•å‰çš„å¤„ç†
        System.out.println("å¼€å¯äº‹åŠ¡æ§åˆ¶...");
        //è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•
        target.save();
        //è°ƒç”¨ç›®æ ‡æ–¹æ³•åçš„å¤„ç†
        System.out.println("å…³é—­äº‹åŠ¡æ§åˆ¶...");
    }
}
```

```java
public class Main {
 Â  Â public static void main(String[] args) {
 Â  Â  Â  Â //æ–°å»ºç›®æ ‡å¯¹è±¡
 Â  Â  Â  Â UserDaoImpl target = new UserDaoImpl();
 Â  Â  Â  Â //åˆ›å»ºä»£ç†å¯¹è±¡, å¹¶ä½¿ç”¨æ¥å£å¯¹å…¶è¿›è¡Œå¼•ç”¨
 Â  Â  Â  Â UserDao userDao = new TransactionHandler(target);
 Â  Â  Â  Â //é’ˆå¯¹æ¥å£è¿›è¡Œè°ƒç”¨
 Â  Â  Â  Â userDao.save();
 Â   }
}
```

#### `ä¼˜ç¼ºç‚¹`â€‹

* **ä¼˜ç‚¹**ï¼šç®€å•æ˜“ç†è§£ï¼Œèƒ½ä¿æŠ¤å®é™…å¯¹è±¡çš„å®‰å…¨ã€‚
* **ç¼ºç‚¹**ï¼šæ¯ä¸ª`æ¥å£`â€‹éƒ½éœ€è¦æ‰‹åŠ¨ç¼–å†™ä»£ç†ç±»ï¼Œå†—ä½™ä¸”ä¸çµæ´»ã€‚

### JDK åŠ¨æ€ä»£ç†

> * spring é»˜è®¤çš„åŠ¨æ€ä»£ç†æ–¹å¼ï¼Œç±»å¦‚æœå®ç°äº†æ¥å£ï¼ŒSpring å°±ä¼šä½¿ç”¨è¿™ç§æ–¹å¼å®ç°åŠ¨æ€ä»£ç†

#### åŸç†

* `JDK`â€‹ çš„åŠ¨æ€ä»£ç†æ˜¯åŸºäº**åå°„**å®ç°ã€‚
* ç¼–å†™ä¸€ä¸ªç±»ï¼Œå®ç° `InvocationHandler`â€‹ æ¥å£
* é€šè¿‡ `Proxy`â€‹ ç±»çš„ `newProxyInstance`â€‹ æ–¹æ³•ï¼Œç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œä»£ç†åŸæ¥é‚£ä¸ªç±»çš„æ‰€æœ‰æ¥å£
* è°ƒç”¨æ–¹æ³•æ—¶ï¼Œé€šè¿‡åå°„è°ƒç”¨ `InvocationHandler`â€‹ æ¥å£çš„ `invoke`â€‹ æ–¹æ³•

```java
public interface Animal {
    void call();
}

public class Cat implements Animal {
    @Override
    public void call() {
        System.out.println("å–µå–µå–µ ~");
    }
}

import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;
import java.lang.reflect.Proxy;

public class JdkProxy implements InvocationHandler {
 
    /** ç›®æ ‡å¯¹è±¡ */
    private Object target;
 
    public JdkProxy(Object target){
        this.target = target;
    }
 
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        System.out.println("------æ’å…¥å‰ç½®é€šçŸ¥ä»£ç -------------");
        // æ‰§è¡Œç›¸åº”çš„ç›®æ ‡æ–¹æ³•
        Object rs = method.invoke(target,args);
        System.out.println("------æ’å…¥åç½®å¤„ç†ä»£ç -------------");
        return rs;
    }

    //å®šä¹‰è·å–ä»£ç†å¯¹è±¡æ–¹æ³•
    public Object getJDKProxy(){
        //JDKåŠ¨æ€ä»£ç†åªèƒ½é’ˆå¯¹å®ç°äº†æ¥å£çš„ç±»è¿›è¡Œä»£ç†ï¼ŒnewProxyInstance å‡½æ•°æ‰€éœ€å‚æ•°å°±å¯çœ‹å‡º

        return Proxy.newProxyInstance(target.getClass().getClassLoader(), // åŠ è½½æ¥å£çš„ç±»åŠ è½½å™¨
                target.getClass().getInterfaces(), // ä»£ç†å¯¹è±¡å®ç°çš„æ¥å£ï¼Œä¸ç›®æ ‡å¯¹è±¡å®ç°åŒæ ·çš„æ¥å£
                this); // è‡ªå®šä¹‰çš„InvocationHandler
    }
}
```

```java
public class MyProxyTest {
    public static void main(String[] args)
            throws NoSuchMethodException, IllegalAccessException, InstantiationException, InvocationTargetException {

        JdkProxy jdkProxy = new JdkProxy(new Cat());//å®ä¾‹åŒ–JDKProxyå¯¹è±¡
        Animal animal = (Animal) jdkProxy.getJDKProxy();//è·å–ä»£ç†å¯¹è±¡
        animal.call();

    }
}
```

#### ä¼˜ç¼ºç‚¹

* **ä¼˜ç‚¹**

  * JDK è‡ªå¸¦ï¼Œä¸éœ€è¦ä»»ä½•ä¾èµ–
  * é€šè¿‡åå°„æœºåˆ¶ç”Ÿæˆä»£ç†ç±»çš„é€Ÿåº¦æ¯” cglib å¿«

* **ç¼ºç‚¹**

  * å¿…é¡»å®ç°æ¥å£
  * æ— æ³•ä¸ºæ²¡æœ‰åœ¨æ¥å£å®šä¹‰çš„æ–¹æ³•å®ç°ä»£ç†â€‹
  * `JDK`â€‹ åŠ¨æ€ä»£ç†æ‰§è¡Œä»£ç†æ–¹æ³•æ—¶ï¼Œéœ€è¦é€šè¿‡åå°„æœºåˆ¶è¿›è¡Œå›è°ƒï¼Œæ­¤æ—¶æ–¹æ³•æ‰§è¡Œçš„æ•ˆç‡æ¯”è¾ƒä½

#### åº•å±‚æºç åˆ†æ

ä» `Proxy#newProxyInstance`â€‹ å…¥å£è¿›è¡Œæºç åˆ†æï¼š

```java
public static Object newProxyInstance(ClassLoader loader, Class<?>[] interfaces,
                                      InvocationHandler h) throws IllegalArgumentException {

    Class<?> cl = getProxyClass0(loader, intfs);
    ã€‚ã€‚ã€‚
}
```

ç»§ç»­è¿½è¸ª getProxyClass0 æ–¹æ³•ï¼Œ

```java
private static Class<?> getProxyClass0(ClassLoader loader,
                                       Class<?>... interfaces) {
    return proxyClassCache.get(loader, interfaces);
}
```

åŸæ¥ä»£ç†ç±»æ˜¯æ”¾åœ¨ä¸€ä¸ªç¼“å­˜ä¸­çš„

```java
private static final WeakCache<ClassLoader, Class<?>[], Class<?>>
    proxyClassCache = new WeakCache<>(new KeyFactory(), new ProxyClassFactory());
```

æœ‰ç‚¹ä¸Šå¤´äº†ç»§ç»­æœ€ç»ˆè¿™ä¸ªç¼“å­˜çš„ get æ–¹æ³•ï¼Œå…¶ä»–çš„é€»è¾‘ä¸åºŸè¯äº†ï¼Œå…·ä½“å°±æ˜¯ä»ç¼“å­˜ä¸­è·å–ä»£ç†ç±»ï¼Œæ²¡æœ‰åˆ™é€šè¿‡ apply æ–¹æ³•åˆ›å»ºä»£ç†ç±»

```java
public V get(K key, P parameter) {
   
    Object subKey = Objects.requireNonNull(subKeyFactory.apply(key, parameter));
    ã€‚ã€‚ã€‚
}
```

åˆ›å»ºä»£ç†ç±»ï¼Œæ‹¨å¼€äº‘é›¾è§æœˆæ˜ï¼Œè¿™é‡Œå°±æ˜¯ä¸ºåˆ›å»ºä»£ç†ç±»åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œæ¯”å¦‚ç»™ä»£ç†ç±»å–ä¸ªåå­—ï¼Œä»£ç†ç±»çš„æ¥å£ï¼Œä»¥åŠä»£ç†ç±»çš„è®¿é—®æ§åˆ¶ç¬¦æœ€åè½è„šåœ¨ generateProxyClass æ–¹æ³•ä¸Š

```java
public Class<?> apply(ClassLoader loader, Class<?>[] interfaces) {
ã€‚ã€‚ã€‚
        byte[] proxyClassFile = ProxyGenerator.generateProxyClass(
            proxyName, interfaces, accessFlags);
   
}
```

åœ¨ generateProxyClass æ–¹æ³•ä¸­æˆ‘ä»¬æ‰çŸ¥é“ï¼Œæ‰€è°“çš„åˆ›å»ºä»£ç†ç±»å°±æ˜¯ç”Ÿæˆä»£ç†ç±»å­—èŠ‚ç çš„è¿‡ç¨‹ã€‚ç›¸æ¯”äºé™æ€ä»£ç†åœ¨ç¨‹åºè¿è¡Œå°±å·²ç»ç”Ÿæˆå­—èŠ‚ç ï¼Œè¿™é‡Œæ˜¯åœ¨ç¨‹åºè¿è¡Œä¸­ç”Ÿæˆå­—èŠ‚ç ï¼Œæœ‰ç‚¹åƒåœ¨è¿è¡Œçš„é©¬è½¦ä¸Šæ¢è½¦è½®ã€‚

```java
public static byte[] generateProxyClass(final String var0, Class<?>[] var1, int var2) {
    ProxyGenerator var3 = new ProxyGenerator(var0, var1, var2);
    final byte[] var4 = var3.generateClassFile();
    ã€‚ã€‚ã€‚

    return var4;
}
```

æ“ä½œç”Ÿæˆå­—èŠ‚ç æ–‡ä»¶åœ¨ `ProxyGenerator#generateProxyClass`â€‹ ä¸­ç”Ÿæˆå…·ä½“çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œå­—èŠ‚ç æ“ä½œè¿™é‡Œä¸åšè¯¦ç»†è®²è§£ã€‚ ç”Ÿæˆçš„å­—èŠ‚ç æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿å­˜æœ¬åœ°è¿›è¡Œåç¼–è¯‘æŸ¥çœ‹ç±»ä¿¡æ¯ã€‚

åç¼–è¯‘æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç†ç±»ï¼š

![1689069236493-02f24eeb-e076-4cf3-a4d5-731e73a5275d-20231204140254-rr08r5y](https://gitee.com/JBL_lun/tuchuang/raw/master/assets/1689069236493-02f24eeb-e076-4cf3-a4d5-731e73a5275d-20231204140254-rr08r5y.png)

ç”Ÿæˆçš„ä»£ç†ç±»ç»§æ‰¿äº† Proxy å’Œå®ç°äº† Animal æ¥å£ï¼Œè°ƒç”¨ `call`â€‹ æ–¹æ³•ï¼Œæ˜¯é€šè¿‡è°ƒç”¨ Proxy æŒæœ‰çš„ InvocationHandler å®ç° `JdkProxy#invoker`â€‹ çš„æ‰§è¡Œã€‚

### CGLIB åŠ¨æ€ä»£ç†

CGLIB åŠ¨æ€ä»£ç†çš„å®ç°æœºåˆ¶æ˜¯é‡‡ç”¨ ASM å­—èŠ‚ç ç”Ÿæˆä»£ç†ç±»çš„å­ç±»ï¼Œé€šè¿‡è°ƒç”¨çˆ¶ç±»ï¼ˆç›®æ ‡ç±»ï¼‰çš„æ–¹æ³•å®ç°ï¼Œåœ¨è°ƒç”¨çˆ¶ç±»æ–¹æ³•æ—¶å†ä»£ç†ä¸­è¿›è¡Œå¢å¼ºã€‚

#### åŸç†

å®ç°`MethodInterceptor`â€‹æ¥å£ï¼Œé‡å†™`intercept`â€‹æ–¹æ³•ï¼Œé€šè¿‡`Enhancer`â€‹ç±»å›è°ƒã€‚

```java
public class TargetInterceptor implements MethodInterceptor {
    @Override
    public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable {
        System.out.println("CGLIB è°ƒç”¨å‰");
        Object result = proxy.invokeSuper(obj, args);
        System.out.println("CGLIB è°ƒç”¨å");
        return result;
    }
}

public class CglibProxy {
    public static Object getProxy(Class<?> clazz){
        Enhancer enhancer = new Enhancer();
        // è®¾ç½®ç±»åŠ è½½
        enhancer.setClassLoader(clazz.getClassLoader());
        // è®¾ç½®è¢«ä»£ç†ç±»
        enhancer.setSuperclass(clazz);
        // è®¾ç½®æ–¹æ³•æ‹¦æˆªå™¨
        enhancer.setCallback(new TargetInterceptor());
        // åˆ›å»ºä»£ç†ç±»
        return enhancer.create();
    }
}
```

```java
public class Main {

    @Test
    public void dynamicProxy() throws Exception {
        Animal cat = (Animal) CglibProxy.getProxy(Cat.class);
        cat.call();
    }
}
```

#### ä¼˜ç¼ºç‚¹

**ä¼˜ç‚¹**

* ä¸éœ€è¦å®ç°æ¥å£ï¼Œç›´æ¥ç»§æ‰¿ç±»ï¼Œç”Ÿæˆçš„ä»£ç†å¯¹è±¡
* æ‰§è¡Œä»£ç†æ–¹æ³•çš„æ•ˆç‡è¦é«˜äº JDK çš„åŠ¨æ€ä»£ç†

**ç¼ºç‚¹**

* ä»£ç†ç±»ä½¿ç”¨çš„ç»§æ‰¿ï¼Œå¦‚æœç±»çš„ `final`â€‹ ç±»ï¼Œåˆ™æ— æ³•ä½¿ç”¨ `CGLib`â€‹
* ä»£ç†æ–¹æ³•æ˜¯é‡å†™çˆ¶ç±»æ–¹æ³•ï¼Œ`final`â€‹ æˆ–è€… `private`â€‹ ä¿®é¥°çš„æ–¹æ³•ï¼Œæ— æ³•é‡å†™

## å¼‚å¸¸

![1675170683749-4118ad04-8350-4171-9bfc-b5dba5476873](https://gitee.com/JBL_lun/tuchuang/raw/master/assets/1675170683749-4118ad04-8350-4171-9bfc-b5dba5476873-20231204151846-uj98kcu.jpeg)â€‹

åœ¨ Java ä¸­ï¼Œæ‰€æœ‰çš„å¼‚å¸¸éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„ç¥–å…ˆ java.lang åŒ…ä¸­çš„ Throwable ç±»ã€‚Throwable ç±»æœ‰ä¸¤ä¸ªé‡è¦çš„å­ç±» Exceptionï¼ˆå¼‚å¸¸ï¼‰å’Œ Errorï¼ˆé”™è¯¯ï¼‰ã€‚

* Exception èƒ½è¢«ç¨‹åºæœ¬èº«å¤„ç†(try-catch)

  * å¯æ£€æŸ¥å¼‚å¸¸ï¼ˆcheckedï¼‰ (å¿…é¡»å¤„ç†)

    * IOException
  * ä¸å—æ£€æŸ¥å¼‚å¸¸ï¼ˆuncheckedï¼‰ (å¯ä»¥ä¸å¤„ç†)

    * NullPointerException
* Error æ˜¯æ— æ³•å¤„ç†çš„(åªèƒ½å°½é‡é¿å…)

  * OutOfMemoryError
  * è¿™äº›å¼‚å¸¸å‘ç”Ÿæ—¶ï¼ŒJava è™šæ‹Ÿæœºï¼ˆJVMï¼‰ä¸€èˆ¬ä¼šé€‰æ‹©çº¿ç¨‹ç»ˆæ­¢

## **æ–‡ä»¶ä¸ IO**

### æ“ä½œç³»ç»Ÿçš„ä¸€æ¬¡ I/O è¿‡ç¨‹

* åº”ç”¨ç¨‹åºè¿›ç¨‹å‘æ“ä½œç³»ç»Ÿå‘èµ· I/O è°ƒç”¨è¯·æ±‚
* æ“ä½œç³»ç»Ÿå‡†å¤‡æ•°æ®ï¼ŒæŠŠ I/O å¤–éƒ¨è®¾å¤‡çš„æ•°æ®ï¼ŒåŠ è½½åˆ°å†…æ ¸ç¼“å†²åŒº
* æ“ä½œç³»ç»Ÿæ‹·è´æ•°æ®ï¼Œå³å°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®ï¼Œæ‹·è´åˆ°ç”¨æˆ·è¿›ç¨‹ç¼“å†²åŒº

![image.png](https://gitee.com/JBL_lun/tuchuang/raw/master/assets/1698753218057-0c495488-d7b6-4ecf-a291-71a630224afc-20231204140254-k34xv4m.png)â€‹

### I/O æ¨¡å‹

#### é˜»å¡ IO

* åº”ç”¨ç¨‹åºçš„è¿›ç¨‹å‘èµ· IO è°ƒç”¨
* å¦‚æœå†…æ ¸çš„æ•°æ®è¿˜æ²¡å‡†å¤‡å¥½ï¼Œåº”ç”¨ç¨‹åºå°±é˜»å¡ç­‰å¾…
* ä¸€ç›´ç­‰åˆ°å†…æ ¸æ•°æ®å‡†å¤‡å¥½äº†ï¼Œä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œæ‰è¿”å›æˆåŠŸæç¤º

#### éé˜»å¡ IO

* åº”ç”¨è¿›ç¨‹å‘æ“ä½œç³»ç»Ÿå†…æ ¸å‘èµ·è¯»æ•°æ®è¯·æ±‚
* æ“ä½œç³»ç»Ÿå†…æ ¸æ•°æ®æ²¡æœ‰å‡†å¤‡å¥½ï¼Œç«‹å³è¿”å›é”™è¯¯ç 
* åº”ç”¨ç¨‹åºè¿›ç¨‹è½®è¯¢è°ƒç”¨ï¼Œç»§ç»­å‘æ“ä½œç³»ç»Ÿå†…æ ¸å‘èµ·è¯»è¯·æ±‚
* æ“ä½œç³»ç»Ÿå†…æ ¸æ•°æ®å‡†å¤‡å¥½äº†ï¼Œä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°ç”¨æˆ·ç©ºé—´
* å®Œæˆè°ƒç”¨ï¼Œè¿”å›æˆåŠŸæç¤º

#### IO å¤šè·¯å¤ç”¨

![image](https://gitee.com/JBL_lun/tuchuang/raw/master/assets/image-20231216151634-19b31r3.png)â€‹

* æ–‡ä»¶æè¿°ç¬¦ fd(File Descriptor)

  * **æ¯ä¸€ä¸ªç½‘ç»œè¿æ¥å…¶å®éƒ½å¯¹åº”ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦**
* æ ¸å¿ƒæ€æƒ³

  * ç³»ç»Ÿç»™æˆ‘ä»¬æä¾›ä¸€ç±»å‡½æ•°ï¼ˆselectã€pollã€epollï¼‰ï¼Œå®ƒä»¬å¯ä»¥åŒæ—¶ç›‘æ§å¤šä¸ª fd çš„æ“ä½œï¼Œä»»ä½•ä¸€ä¸ªè¿”å›å†…æ ¸æ•°æ®å°±ç»ªï¼Œåº”ç”¨è¿›ç¨‹å†å‘èµ· recvfrom ç³»ç»Ÿè°ƒç”¨
* å¤šè·¯å¤ç”¨ä¹‹ select

  * åº”ç”¨è¿›ç¨‹é€šè¿‡è°ƒç”¨ select å‡½æ•°ï¼Œå¯ä»¥åŒæ—¶ç›‘æ§å¤šä¸ª fd
  * åœ¨ select å‡½æ•°ç›‘æ§çš„ fd ä¸­ï¼Œåªè¦æœ‰ä»»ä½•ä¸€ä¸ªæ•°æ®çŠ¶æ€å‡†å¤‡å°±ç»ªäº†ï¼Œselect å‡½æ•°å°±ä¼šè¿”å›å¯è¯»çŠ¶æ€ï¼Œè¿™æ—¶åº”ç”¨è¿›ç¨‹å†å‘èµ· recvfrom è¯·æ±‚å»è¯»å–æ•°æ®
  * ç¼ºç‚¹

    * ç›‘å¬çš„ IO æœ€å¤§è¿æ¥æ•°æœ‰é™ï¼Œä¸€èˆ¬ 1024
    * select å‡½æ•°è¿”å›åï¼Œæ˜¯é€šè¿‡éå† fdsetï¼Œæ‰¾åˆ°å°±ç»ªçš„æè¿°ç¬¦ fdã€‚(ä»…çŸ¥é“æœ‰ I/O äº‹ ä»¶å‘ç”Ÿï¼Œå´ä¸çŸ¥æ˜¯å“ªå‡ ä¸ªæµï¼Œæ‰€ä»¥éå†æ‰€æœ‰æµ)
* IO å¤šè·¯å¤ç”¨ä¹‹ epoll

  * å…ˆé€šè¿‡ epoll_ctl()æ¥æ³¨å†Œä¸€ä¸ª fd(æ–‡ä»¶æè¿°ç¬¦)ï¼Œä¸€æ—¦åŸºäºæŸä¸ª fd å°±ç»ªæ—¶ï¼Œå†…æ ¸ä¼šé‡‡ç”¨å›è°ƒæœºåˆ¶ï¼Œè¿…é€Ÿæ¿€æ´»è¿™ä¸ª fd
  * å½“è¿›ç¨‹è°ƒç”¨ epoll_wait()æ—¶ä¾¿å¾—åˆ°é€šçŸ¥ã€‚è¿™é‡Œå»æ‰äº†éå†æ–‡ä»¶æè¿°ç¬¦çš„å‘çˆ¹æ“ä½œï¼Œè€Œæ˜¯é‡‡ç”¨ç›‘å¬äº‹ä»¶å›è°ƒçš„æœºåˆ¶

#### ä¿¡å·é©±åŠ¨æ¨¡å‹

* ä¸å†ç”¨ä¸»åŠ¨è¯¢é—®çš„æ–¹å¼å»ç¡®è®¤æ•°æ®æ˜¯å¦å°±ç»ªï¼Œè€Œæ˜¯å‘å†…æ ¸å‘é€ä¸€ä¸ªä¿¡å·
* ç„¶ååº”ç”¨ç”¨æˆ·è¿›ç¨‹å¯ä»¥å»åšåˆ«çš„äº‹ï¼Œä¸ç”¨é˜»å¡
* å½“å†…æ ¸æ•°æ®å‡†å¤‡å¥½åï¼Œå†é€šè¿‡ SIGIO ä¿¡å·é€šçŸ¥åº”ç”¨è¿›ç¨‹ï¼Œæ•°æ®å‡†å¤‡å¥½åçš„å¯è¯»çŠ¶æ€
* åº”ç”¨ç”¨æˆ·è¿›ç¨‹æ”¶åˆ°ä¿¡å·ä¹‹åï¼Œç«‹å³è°ƒç”¨ recvfromï¼Œå»è¯»å–æ•°æ®

> **ä¸ç®¡æ˜¯ BIOï¼Œè¿˜æ˜¯ NIOï¼Œè¿˜æ˜¯ä¿¡å·é©±åŠ¨ï¼Œåœ¨æ•°æ®ä»å†…æ ¸å¤åˆ¶åˆ°åº”ç”¨ç¼“å†²çš„æ—¶å€™ï¼Œéƒ½æ˜¯é˜»å¡çš„**

#### å¼‚æ­¥ IO(AIO)

* åº”ç”¨è¿›ç¨‹å‘å‡ºç³»ç»Ÿè°ƒç”¨åï¼Œæ˜¯ç«‹å³è¿”å›çš„ï¼Œä½†æ˜¯ç«‹å³è¿”å›çš„ä¸æ˜¯å¤„ç†ç»“æœï¼Œè€Œæ˜¯è¡¨ç¤ºæäº¤æˆåŠŸç±»ä¼¼çš„æ„æ€
* ç­‰å†…æ ¸æ•°æ®å‡†å¤‡å¥½ï¼Œå°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·è¿›ç¨‹ç¼“å†²åŒºï¼Œå‘é€ä¿¡å·é€šçŸ¥ç”¨æˆ·è¿›ç¨‹ I/O æ“ä½œæ‰§è¡Œå®Œæ¯•

### é›¶æ‹·è´

#### ä¼ ç»Ÿ I/O çš„æ‰§è¡Œæµç¨‹

* è¿‡ç¨‹

  * ç”¨æˆ·åº”ç”¨è¿›ç¨‹è°ƒç”¨ read å‡½æ•°ï¼Œå‘æ“ä½œç³»ç»Ÿå‘èµ· IO è°ƒç”¨ï¼Œ**ä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€è½¬ä¸ºå†…æ ¸æ€ï¼ˆåˆ‡æ¢ 1ï¼‰**
  * DMA æ§åˆ¶å™¨æŠŠæ•°æ®ä»ç£ç›˜ä¸­ï¼Œè¯»å–åˆ°å†…æ ¸ç¼“å†²åŒº
  * CPU æŠŠå†…æ ¸ç¼“å†²åŒºæ•°æ®ï¼Œæ‹·è´åˆ°ç”¨æˆ·åº”ç”¨ç¼“å†²åŒºï¼Œ**ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€è½¬ä¸ºç”¨æˆ·æ€ï¼ˆåˆ‡æ¢ 2ï¼‰** ï¼Œread å‡½æ•°è¿”å›
  * ç”¨æˆ·åº”ç”¨è¿›ç¨‹é€šè¿‡ write å‡½æ•°ï¼Œå‘èµ· I/O è°ƒç”¨ï¼Œ**ä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€è½¬ä¸ºå†…æ ¸æ€ï¼ˆåˆ‡æ¢ 3ï¼‰**
  * CPU å°†ç”¨æˆ·ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œæ‹·è´åˆ° socket ç¼“å†²åŒº
  * DMA æ§åˆ¶å™¨æŠŠæ•°æ®ä» socket ç¼“å†²åŒºï¼Œæ‹·è´åˆ°ç½‘å¡è®¾å¤‡ï¼Œ**ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆåˆ‡æ¢ 4ï¼‰** ï¼Œwrite å‡½æ•°è¿”å›
* ä¼ ç»Ÿ IO çš„è¯»å†™æµç¨‹ï¼ŒåŒ…æ‹¬äº† 4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆ4 æ¬¡ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼‰ï¼Œ4 æ¬¡æ•°æ®æ‹·è´ï¼ˆä¸¤æ¬¡ CPU æ‹·è´ä»¥åŠä¸¤æ¬¡çš„ DMA æ‹·è´)
* ![image.png](https://gitee.com/JBL_lun/tuchuang/raw/master/assets/1698753322239-aea9d3c2-4730-4401-b0ab-8579acf068d7-20231204140254-18lt990.png)â€‹

#### å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´

* æ–‡ä»¶è¯»å†™ç­‰æ¯”è¾ƒå±é™©çš„æ“ä½œï¼Œä¸åº”ç”±åº”ç”¨ç¨‹åºä¹±æ¥ï¼Œäº¤ç»™åº•å±‚æ“ä½œç³»ç»Ÿå®Œæˆ
* æ“ä½œç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹éƒ½åˆ†é…äº†å†…å­˜ç©ºé—´ï¼Œä¸€éƒ¨åˆ†æ˜¯ç”¨æˆ·ç©ºé—´ï¼Œä¸€éƒ¨åˆ†æ˜¯å†…æ ¸ç©ºé—´
* å†…æ ¸ç©ºé—´æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸è®¿é—®çš„åŒºåŸŸï¼Œæ˜¯å—ä¿æŠ¤çš„å†…å­˜ç©ºé—´ï¼Œè€Œç”¨æˆ·ç©ºé—´æ˜¯ç”¨æˆ·åº”ç”¨ç¨‹åºè®¿é—®çš„å†…å­˜åŒºåŸŸ

#### ç”¨æˆ·æ€ã€å†…æ ¸æ€

* å¦‚æœè¿›ç¨‹è¿è¡Œäºå†…æ ¸ç©ºé—´ï¼Œè¢«ç§°ä¸ºè¿›ç¨‹çš„å†…æ ¸æ€
* å¦‚æœè¿›ç¨‹è¿è¡Œäºç”¨æˆ·ç©ºé—´ï¼Œè¢«ç§°ä¸ºè¿›ç¨‹çš„ç”¨æˆ·æ€

#### è™šæ‹Ÿå†…å­˜

* ç°ä»£æ“ä½œç³»ç»Ÿä½¿ç”¨è™šæ‹Ÿå†…å­˜ï¼Œå³è™šæ‹Ÿåœ°å€å–ä»£ç‰©ç†åœ°å€

  * è™šæ‹Ÿå†…å­˜ç©ºé—´å¯ä»¥è¿œè¿œå¤§äºç‰©ç†å†…å­˜ç©ºé—´
  * å¤šä¸ªè™šæ‹Ÿå†…å­˜å¯ä»¥æŒ‡å‘åŒä¸€ä¸ªç‰©ç†åœ°å€
* æ­£æ˜¯å¤šä¸ªè™šæ‹Ÿå†…å­˜å¯ä»¥æŒ‡å‘åŒä¸€ä¸ªç‰©ç†åœ°å€ï¼Œå¯ä»¥æŠŠå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°åŒä¸€ä¸ªç‰©ç†åœ°å€ï¼Œè¿™æ ·çš„è¯ï¼Œå°±å¯ä»¥å‡å°‘ IO çš„æ•°æ®æ‹·è´æ¬¡æ•°å•¦
* ![image.png](https://gitee.com/JBL_lun/tuchuang/raw/master/assets/1698753339888-74c1ff18-34b5-45b5-b527-787eebce8a12-20231204140254-jhqfp2u.png)â€‹

#### DMA æŠ€æœ¯

* å¸®å¿™ CPU è½¬å‘ä¸€ä¸‹ IO è¯·æ±‚ï¼Œä»¥åŠæ‹·è´æ•°æ®
* æé«˜ CPU çš„åˆ©ç”¨æ•ˆç‡
* å¤§ç™½è¯è§£é‡Šå°±æ˜¯ï¼ŒCPU è€å“¥å¤ªå¿™å¤ªç´¯å•¦ï¼Œæ‰€ä»¥ä»–æ‰¾äº†ä¸ªå°å¼Ÿï¼ˆåå« DMAï¼‰ ï¼Œæ›¿ä»–å®Œæˆä¸€éƒ¨åˆ†çš„æ‹·è´å·¥ä½œï¼Œè¿™æ · CPU è€å“¥å°±èƒ½ç€æ‰‹å»åšå…¶ä»–äº‹æƒ…

#### é›¶æ‹·è´å®ç°çš„å‡ ç§æ–¹å¼

* mmap+write å®ç°çš„é›¶æ‹·è´æµç¨‹å¦‚ä¸‹

  * åˆ©ç”¨äº†è™šæ‹Ÿå†…å­˜çš„ç‰¹ç‚¹ï¼Œå®ƒå°†å†…æ ¸ä¸­çš„è¯»ç¼“å†²åŒºä¸ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºè¿›è¡Œæ˜ å°„ï¼Œæ‰€æœ‰çš„ IO éƒ½åœ¨å†…æ ¸ä¸­å®Œæˆ
  * è¿‡ç¨‹

    * ç”¨æˆ·è¿›ç¨‹é€šè¿‡ mmap æ–¹æ³•å‘æ“ä½œç³»ç»Ÿå†…æ ¸å‘èµ· IO è°ƒç”¨ï¼Œ**ä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€åˆ‡æ¢ä¸ºå†…æ ¸æ€**ï¼ˆåˆ‡æ¢ 1ï¼‰
    * CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨ï¼ŒæŠŠæ•°æ®ä»ç¡¬ç›˜ä¸­æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒº
    * **ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€**ï¼Œmmap æ–¹æ³•è¿”å›ï¼ˆåˆ‡æ¢ 2ï¼‰
    * ç”¨æˆ·è¿›ç¨‹é€šè¿‡ write æ–¹æ³•å‘æ“ä½œç³»ç»Ÿå†…æ ¸å‘èµ· IO è°ƒç”¨ï¼Œ**ä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€åˆ‡æ¢ä¸ºå†…æ ¸æ€**ï¼ˆåˆ‡æ¢ 3ï¼‰
    * CPU å°†ç”¨æˆ·ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œæ‹·è´åˆ° socket ç¼“å†²åŒº
    * CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨ï¼ŒæŠŠæ•°æ®ä» socket ç¼“å†²åŒºæ‹·è´åˆ°ç½‘å¡ï¼Œ**ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€**ï¼ˆåˆ‡æ¢ 4ï¼‰ï¼Œwrite è°ƒç”¨è¿”å›
  * åŒ…æ‹¬äº† 4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆ4 æ¬¡ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼‰ï¼Œ3 æ¬¡æ•°æ®æ‹·è´ï¼ˆ1 æ¬¡ CPU æ‹·è´ä»¥åŠ 2 æ¬¡çš„ DMA æ‹·è´)
  * ![image.png](https://gitee.com/JBL_lun/tuchuang/raw/master/assets/1698753358621-47147df5-2c48-4924-bca0-9a3b5295ad50-20231204140254-0nagtet.png)â€‹
* sendfile

  * sendfile è¡¨ç¤ºåœ¨ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹é—´ä¼ è¾“æ•°æ®ï¼Œå®ƒæ˜¯åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­æ“ä½œçš„ï¼Œé¿å…äº†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºå’Œç”¨æˆ·ç¼“å†²åŒºä¹‹é—´çš„æ‹·è´æ“ä½œ
  * sendfile+DMA scatter/gather å®ç°çš„é›¶æ‹·è´æµç¨‹å¦‚ä¸‹ï¼š

    * ç”¨æˆ·è¿›ç¨‹å‘èµ· sendfile ç³»ç»Ÿè°ƒç”¨ï¼Œ**ä¸Šä¸‹æ–‡ï¼ˆåˆ‡æ¢ 1ï¼‰ä»ç”¨æˆ·æ€è½¬å‘å†…æ ¸æ€**
    * DMA æ§åˆ¶å™¨ï¼ŒæŠŠæ•°æ®ä»ç¡¬ç›˜ä¸­æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒº
    * CPU æŠŠå†…æ ¸ç¼“å†²åŒºä¸­çš„**æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯**ï¼ˆåŒ…æ‹¬å†…æ ¸ç¼“å†²åŒºçš„å†…å­˜åœ°å€å’Œåç§»é‡ï¼‰å‘é€åˆ° socket ç¼“å†²åŒº
    * DMA æ§åˆ¶å™¨æ ¹æ®æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯ï¼Œç›´æ¥æŠŠæ•°æ®ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°ç½‘å¡
    * **ä¸Šä¸‹æ–‡ï¼ˆåˆ‡æ¢ 2ï¼‰ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€**ï¼Œsendfile è°ƒç”¨è¿”å›ã€‚
  * I/O å‘ç”Ÿäº† **2** æ¬¡ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»¥åŠ 2 æ¬¡æ•°æ®æ‹·è´ã€‚å…¶ä¸­ 2 æ¬¡æ•°æ®æ‹·è´éƒ½æ˜¯åŒ… **DMA æ‹·è´**ã€‚è¿™å°±æ˜¯çœŸæ­£çš„ **é›¶æ‹·è´ï¼ˆZero-copy)**  æŠ€æœ¯ï¼Œå…¨ç¨‹éƒ½æ²¡æœ‰é€šè¿‡ CPU æ¥æ¬è¿æ•°æ®ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯é€šè¿‡ DMA æ¥è¿›è¡Œä¼ è¾“çš„ã€‚
  * ![1699256181712-c6b873a5-64ae-4fe2-b92b-634c2a53fbf4](https://gitee.com/JBL_lun/tuchuang/raw/master/assets/1699256181712-c6b873a5-64ae-4fe2-b92b-634c2a53fbf4-20231204152016-2gcw0s9.png)â€‹

â€
